# 区块链

    区块链是一种集成了点对点传输协议, 现代密码学, 共识算法, 分布式数据存储等成型技术 新型的应用模型
    从字面理解, 区块链包含了两个概念: 区块, 链
    区块链本身是由一个个区块(Block)组成, 不同节点链接在一起构成的网络, 就是区块链
    区块链的主要作用是储存信息, 任何需要保存的信息, 都可以写入区块链, 也可以从里面读取

## 区块链的发展历史

1. 1.0-2009年, 比特币诞生
2. 2.0-2014年, 以太坊诞生
3. 3.0-2018年, EOS主网上线
4. 4.0-Fabric

## 区块链的特点

1. 可追溯
2. 不可篡改
3. 去中心化
4. 完整备份: 区块链具有完整的分布式存储
5. 历史记录: 被存储的数据拥有完整的历史记录, 可以快速查看, 复原
6. 交易广播: 一次交易分发给网络中的其它节点, 同步进行接收

## 区块链加密货币的特点

1. 独立性: 所有的货币都是独立存在的
2. 唯一性: 地址, 交易 都具有不重复的唯一性
3. 匿名性: 账户信息和个人信息没有关联, 整个交易过程全程加密
4. 不可伪造

## 核心技术

1. 点对点传输协议(P2P): 由多个节点组成的对等网络, 网络中的任意一个节点都可以互相传输, 每一个节点都是平等的, 可以保证数据的 自由,平等,透明,高效
2. 现代密码学: 在区块链中的应用: 公钥私钥签名, 哈希算法
3. 共识算法: 为了达成数据的一致性
4. 分布式数据存储: 实现去中心化的重要技术依据


## 核心概念

### 区块链

    本质: 一个分布式**账本**, 通过共识算法来决定谁能抢到当前的**记账权**. 以**区块**为单位, 以区块产生的时间顺序去**连接**.

### 区块
    
    区块链的基本组成单位

1. 区块头
   1. hashCode: 当前节点的哈希值
   2. preHash: 前一个结点的哈希
   3. timeStamp: 时间戳, 区块生成的时间
   4. Diff: 网络难度系数, 与前导0有关, 若前导0符合难度系数, 则挖矿成功
   5. Data: 交易信息
   6. index: 区块高度(第一个块高度为 1 or 0)
   7. Nonce: 随机值
   8. Merkle 树
2. 区块体: 用于存储交易数据
3. 分布式数据库: 区块链中的区块数据都存储在每一个节点中, 所有节点组成一个分布式数据库. 任何一个或多个节点退出, 都不会影响其它节点, 因为每个节点都保存了完整的数据.

### 节点

1. 可以理解成为一个运行区块链软件的计算机
2. 分类
   1. 全节点: 保存了完整的区块链副本, 去安全性极高, 效率不高
   2. 轻节点: 不保存所有的区块, 需要依赖全节点进行验证, 效率更高, 安全不如全节点
   3. 挖矿节点: 带有挖矿功能的全节点, 专门处理交易验证

### 挖矿

1. 对交易进行验证处理(记账), 区块就是通过挖矿产生的
2. 穷举随机数算法, 生成哈希, 与目标哈希进行比较, 成功则说明挖矿成功

### 分叉

1. 升级分叉, 矿工遵从不同的规则导致的分叉
   1. 硬分叉: 如果区块链共识规则改变之后, 不允许前向兼容, 旧节点没有办法认可新节点产生的区块
   2. 软分叉: 如果区块链共识规则改变之后, 允许前向兼容, 旧节点可以兼容新节点产生的区块
2. 挖矿分叉, 两个或多个矿工, 同时完成了工作量证明, 就会产生两个新的区块, 形成分叉; 不同的矿工跟随了不同的区块, 但是不同链算力会有区别, 矿工的数量不一样, 链的增长速度就不会相同, 最终会出现一条链更长, 这条链就会变成主链

### 51% 攻击

### 交易

1. 概念: 一笔资产在参与者之间的转移
2. 内容
   1. 金额
   2. 发送者
   3. 接收者
   4. 交易ID(Hash)

### 双重支付
   
   1. 概念: 利用数字货币的数字特性, 可以完成两次或者多次支付
   2. 传统货币具有天然的避免双花的特性
   3. 传统的虚拟货币之所以可以避免双花, 是因为有可以来的第三方机构提供保证
   4. 区块中需要达成只通过分布式节点之间的相互校验与工时机制来避免双花, 同时完成价值转移

### UTXO(unspent transaction output) 交易模式

   1. 是比特币独有的交易模式, 比特币交易过程中的基本单位, 主要就是为了避免双花

### 哈希

   1. 将任意的原始数据(交易记录)通过指定哈希函数, 编码为特定长度的字符串
   2. 在区块链中的使用: 生成地址, 交易验证
   3. 特点
      1. 不可逆
      2. 随机性
      3. 时间正相关: 输入的源数据越长, 哈希的处理时间就更长

### 加密算法

   1. 对称加密: 加密与解密都使用相同的密钥
   2. 非对称加密: 采用公钥和私钥进行解密, 无法用公钥反推私钥

### 数字签名

### Merkle 树

   1. 可以是二叉树, 也可以是多叉树, 它具有树的所有特点
   2. 在区块链中的作用: 快速校验, 归纳交易数据的完整性
   3. 在区块链中, Merkle 树可以极大的提高查询效率, 区块头只需要保存一个 Merkle 根的 hash
   4. Merkle 支持 SPV

### P2P

   1. 通过对等网络来分配工作任务, 其实就是一个分布式的应用架构
   2. 使用: 迅雷采用的就是 P2P
   3. 由于在 P2P 中, 所有网络节点的地位是对等的, 不存在任何一个中心化节点, 也不存在所谓的层级结构, 所以每个节点都需要承担验证区块数据等功能
   
## 区块链的分类

### 公有链

   真正意义上的去中心化分布式区块链, 任何一个节点都可以随时 加入/退出 网络中

### 私有链

   部分中心化的区块链, 具有一定的分布式特点, 但是有一个中心节点, 可以指定参与者

### 联盟链

   部分去中心化的区块链, 拥有权限控制的功能
   代表: Fabric

## 区块链架构特点

### 去中心化

   基于分布式系统, 整个网络中没有中心机构存在

### 可靠的数据库

   分布式存储, 参与系统的节点越多, 数据的安全性越高

### 开源可编程

   区块链提供了灵活的脚本系统, 甚至于完善的开发平台, 可以支持用户创建更加高级的应用

### 集体维护

   区块链中的数据, 由整个系统中所有具有记账功能的节点进行维护

### 安全可信

   通过现代密码学实现

### 准匿名性

   采用与身份信息无关的哈希作为交易 ID

## 典型的应用分析

### 比特币

1. 特点
   1. 总数 2100W, 永不增发
   2. 挖矿奖励, 逐年减半
2. 架构
   1. 前端
      1. 钱包: 保存用户私钥, 管理用户余额, 提供比特币交易(支付, 转账)
      2. 钱包分类
         1. 决定性钱包: 所有的私钥都由一个私钥种子, 通过单项哈希算法生成
            1. 普通决定性钱包: 由私钥种子一次性生成所有私钥
            2. 层级决定性钱包: 由私钥种子生成父私钥, 再有父私钥生成子私钥
         2. 非决定性钱包: 直接保存私钥, 私钥直接放在 DB(或文件) 中
      3. 展示方式的分类
         1. 桌面钱包
            1. 厚钱包: 下载整条区块链, 可以进行完整交易, 安全性高, 验证成本高
            2. 薄钱包: 不会下载整条区块链, 采用部分存储 + 节点请求验证的方式
            3. 离线钱包: USB设备, 纸钱包, 可以有效防范网络攻击
         2. HTTP/JSON RPC API
            1. 比特币提供的接口, 可以使外部通过该接口访问或者控制比特币节点
         3. 命令行接口
            1. 通过命令行的方式实现类似钱包的功能
         4. 浏览器
            1. 访问区块链的区块数据
         5. QT(图形化开发工具)
   2. 节点后台: 负责参与比特币网络的 通信,区块链维护,验证,交易...
   3. 比特币地址
      1. 基本概念: 由哈希生成
      2. 生成过程
         1. 随机数生成私钥
         2. 采用Secp256椭圆加密算法生成公钥
      3. 生成地址
         1. 以公钥作为输入, 进行 SHA256, 再进行 RIPEMD160, 最后通过 base58 编码生成比特币地址
   4. 比特币区块校验: 确保确实完成了工作量证明
      1. 校验内容: 格式, 难度, 时间戳, 大小, 交易 
   5. 比特币交易(UTXO)
      1. 交易结构
         1. 输入(input)
         2. 输出(金额包含在输出中)(output)
         3. 交易ID(HASH)
      2. 说明
         1. 每一笔交易的输入都来自于前面交易的输出
      3. UTXO数据库: 专门用于存储当前比特币中未被花费的输出

### 以太坊

1. 以太坊基本概念: 一个用于开发去中心化 DAPP 的分布式平台
2. 智能合约: 一个拥有自我校验与自我执行的协议
3. 以太坊为什么可以被成为区块链2.0: 以太坊提供了非常方便的应用开发平台, 对底层做了完善的封装, 让开发者只需要关注于上层应用
4. 共识算法: POW(改进版, 添加了 ETHASH)

### EOS

1. EOS 基本概念: 一个用于开发去中心化的 DAPP 的分布式平台
2. 与以太坊的比较:
   1. TPS 有了极大的提高, 号称能够达到百万计的 TPS 处理量(截止到 2021-12-03 以太坊 TPS 为 14.5)
   2. 以太坊本身是一条公链, 其中每个 DAPP 会消耗整条链上的资源
   3. EOS 本身不再是一条单独的公链, 它是一个区块链的基础架构, 开发者可以自由在 EOS 上面创建公链, 链与链之间不会影响彼此的资源使用, 因此, 不会出现单个应用占用的资源太多, 使得整个网络拥堵
3. 共识算法: DPOS
4. EOS 上的智能合约调用不需要手续费

### Fabric(联盟链)

1. 联盟链代表, 与公链最大的区别在于不发币
2. 目标: 实现一个通过权限管理区块链的底层基础框架(R3联盟)
3. 架构分类
   1. 身份服务: Fabric 具有身份识别能力, 加入/退出 Fabric 网络需要权限认证
   2. 策略服务: 提供访问控制, 授权等一系列功能
   3. 区块链服务: 提供构建分布式账本的基础能力, 以及数据传输, 共识达成的底层功能
   4. 智能合约: 验证节点上运行的分布式程序, 用于自动执行特定的业务规则


## 比特币交易原理

### 传统的 web 交易
   
### 基本概念

1. 比特币系统中的交易没有余额的概念, 它使用的是 UTXO 交易模型, 在传统交易过程中所说的交易余额
   实际上指的是一个比特币钱包地址的 UTXO 集合

### 交易组成

1. 在比特币中, 交易主要由 输入,输出,ID(txHash),交易时间 组成

### UTXO 交易模型

1. 比特币专有的交易模型
2. 在比特币中, 交易实际上就是不断查找指定钱包地址的 UTXO 集合, 然后进行修改的过程
3. UTXO 是比特币交易中最基本的单元, 是不可拆分的, 可以把 UTXO 理解成一个币, 该币拥有一个金额, 一个拥有者.

### 交易过程
    
1. 如何保证用户只是用属于自己的比特币
2. 如果保证一笔交易是有效的
3. 交易分类
   1. coinbase: 挖矿奖励的比特币, 没有发送者, 由系统提供, 所以不包含 input
   2. 普通转账: 正常的转账交易, 有发送者参与, 所以包含 input





## 挖矿的过程

1. 通过 PoW 挖矿
2. 将区块放到链中(链表)
3. 数据持久化存储(levelDB)
4. 在广域网中做广播(UDP)

## 共识算法

### PoW(Proof-of-Work, 工作量证明)

#### 优点

1: 基于经济学原理, 挖矿难度的自动调节等
2: 实现了相对的公平

#### 缺点

1: 需要算力挖矿, 需要直接的消耗资源
2: 安全性待考量
## 超级账本(hyperledger fabric)

## EOS(区块链 3.0)

