# Amazon

    亚马逊云使用教程

## VPC

    借助 Amazon Virtual Private Cloud（Amazon VPC）, 您可以在自己定义的逻辑隔离的虚拟网络中启动 AWS 资源。这个虚拟网络与您在数据中心中运行的传统网络极其相似, 并会为您提供使用的可扩展基础设施的优势 AWS。
    当然我是每太看明白这玩意干嘛用的, 不过每个账号都会有一个默认的 VPC, 选择默认的即可

1. 创建一个新的 VPC
2. 选择仅 VPC
3. 输入一个 Name
4. 选择 IPv4 CIDR 手动输入,  我不太明白这是干嘛的,  输入框输入 172.31.0.0/16
5. 点击创建

## 安全组

    针对不同的服务创建不同的安全组, 为了演示此处只创建一个安全组
    安全组入站规则配置 HTTP(80), HTTPS(443), MYSQL(3306), SSH(22) 端口允许全部来源

1. 创建安全组
2. 输入安全组名称和描述信息
3. 选择 VPC,  选择默认的即可
4. 配置入站规则
5. 出战规则根据需要配置, 基本上配置所有流量
6. 点击创建安全组

## EC2

    创建一个弹性 EC2 实例

1. 点击启动实例
2. 输入实例名称
3. 选择镜像, 搜索选择 centos, 快速启动中的 Amazon Linux 我使用密钥从来都他妈没登录成果过, 就不知道为啥
4. 实例类型按需选择
5. 创建密钥对, 输入密钥对名称, 密钥类型选择 RSA,  私钥文件格式选择 .pem, 点击创建密钥对, 创建完后会自动把私钥下载下来, 一定一定找个稳妥的地方把这玩意保存下来, 就这一次机会, 丢了就再也找不回来了, 最好下载下来之后连剪切都不要, 直接使用, 靠
6. 网络设置, 默认会选择默认创建的 VPC 网络, 不需要修改, 防火墙(安全组选择自己刚刚创建的哪个)
7. 配置存储, 选择硬盘, 按需选择
8. 其它信息默认即可
9. 点击启动实例, 等待初始化完成
10. 使用 XShell 用公有 ip 和 密钥文件登录即可
11. 此时使用公有 ip 地址实际上是可以使用的了, 比如说安装一个 nginx, 浏览器访问就可以被访问到

### 启用 root 用户并允许 root 用户及密码登录

1. 执行命令 sudo passwd root 修改 root 密码
2. su root 切换到 root
3. vi /etc/ssh/sshd_config 修改 PasswordAuthentication 为 yes
4. service sshd restart重启sshd服务, 之后可以使用密码模式进行登录

## Amazon RDS

1. 直接进入 Amazon RDS 控制面板创建一个数据库
2. 选择数据库创建方法-标准创建（或者其它）
3. 引擎选项-MySQL
4. 引擎版本-最新的即可
5. 模板 看具体需要
6. 可用性与持久性看具体需要, 无特殊需求选择单个数据库实例
7. 设置-数据库(集群/实例)标识符写一个, 主用户名建议用root, 下面两个选项不选, 输入主密码
8. 实例配置根据实际需要选择
9. 存储根据实际需要选择
10. 连接计算类型选择不要连接到 EC2 计算资源, 网络类型选择 IPv4, VPC 选一个默认的, 数据库子网组选一个默认的, 公开访问选择是, VPC 安全组(这个建议预先设置好直接选择), 可用区不用管, RDS代理不用管, 证书颁发机构默认,
11. 其它配置可以设置数据库端口
12. 监控-性能详情这个按照需要可以配置一下, 记得把 账户和KMS密钥ID保存起来, 曾江监控这个根据需要来
13. 剩下的都选择默认即可
14. 最后远程数据库连接, 需要自行配置一下安全组才行, URL 使用 终端节点, 端口使用设置的端口, 用户名密码使用设置的主用户名密码

### 申请证书

1. 切换至 AWS Certificate Manager 控制台
2. 点击请求证书
3. 选择请求公有证书, 点击下一步
4. 输入完全限定域名, 一次一个域名配置一个证书(具体针对 a.com 和 www.a.com 的配置需要再进行研究)
5. 验证方法选择 DNS 验证
6. 密钥算法选择 RSA 2048
7. 点击请求之后会在证书列表看到一条记录, 状态为等待验证, 点进去, 点一下 在 Route 53 中创建记录 按钮, 过一会儿就会验证通过了
8. 此时仅仅是申请下来证书, 要使用证书还需要后面的操作

## 配置域名

    到了最痛苦的地方了, 上面的所有所作都很正常, 但是，到了配置域名的时候就他妈的坑了，shit
    以下列出各种不同的配置方式
    1. http 解析（适用于Java服务）
    2. http 解析 + CDN （适用于前端服务）
    3. https 解析（适用于Java服务）
    4. https 解析 + CDN（适用于前端服务）

### 单纯 HTTP 解析

    针对 Java 服务

1. 切换控制台至 Route 53
2. 点击托管区域, 选择已购买的域名, 然后进入点击创建记录
3. 记录类型选择 A,  值输入上面的公有 ip 点击创建记录即可
4. 是的，你没看错，这类的操作非常简单，但是不要被假象迷惑到了，这种操作除非垃圾的要死的网站或者测试，否则基本上不可能用到

### HTTP 解析 + CDN

    针对前端服务
    因为需要配置 CDN，这种情况就坑爹了一点
    举例：我们现在有一台服务器 A，公网 IP 为 111.111.111.111，开放端口 80（此端口部署了一个前端项目），
    我们还需要准备两个域名 abcd.com 和 abcdcdn.com，此时我们让 abcdcdn.com 解析到 111.111.111.111，
    然后我们为 abcdcdn.com 配置 CDN，CDN 服务会为我们自动生成一个新的域名 *******.cloudfront.net，
    注意，配置好后我们再访问 abcdcdn.com 的时候是不走 CDN 的，而是会走到我们的服务器，只有我们访问 *******.cloudfront.net 的时候才会走到 CDN，
    过程就是访问 *******.cloudfront.net，CDN 服务查找对应的域名（即 abcdcdn.com）是否有缓存，若有直接响应缓存，若没有则为其加载并缓存，然后再相应。
    那么现在我们基本上 CDN 的需求解决了，但是问题是我们不可能开放给客户一个 *******.cloudfront.net 这样的域名，这不合理，所以我们最初的那个
    abcd.com 就起作用了，切换控制台至 Route 53，abcd.com 添加一个 CNAME 解析，目标为 *******.cloudfront.net，然后我们再访问 abcd.com
    就会发现打开的网站是经过 CDN 的了。
    以下为步骤默认使用上面的例子

1. 将 abcdcdn.com 解析到服务器
2. 切换到 CloudFront 控制台分配列表，点击创建按钮
3. 输入源域 http://abcdcdn.com，协议选项选择仅 HTTP，HTTP 端口 80（此处更换端口是不是可以少解析这种 CDN源域名？）
4. 源路径根据需要自行填写，名称默认即可，其它的默认
5. 缓存键和源请求，选择第一个，缓存策略选择第一个，其它继续默认
6. Web Application Firewall(WAF) 选择第一个
7. 设置，价格级别选择 使用所有边缘站点（最佳性能），备用域名这一步一定要进行配置，点击添加项目输入 abcd.com，不然后面解析之后不生效
8. 其它默认，最后点击创建分配

### HTTPS 解析 + CDN

    针对前端服务
    此时我们需要先为 abcd.com 申请一个证书
    申请证书参考上面申请证书的步骤，注意的一点是证书区域必须选择 美国东部（弗吉尼亚北部）
    然后再重复 HTTP解析 + CDN 的步骤，需要注意的是再设置模块的自定义 SSL 证书要选择刚才的那个证书

### HTTPS   

    针对 Java 服务
    以下操作每一步都是针对的一个域名一个端口进行配置的, 实在是搞不懂亚马逊的这些花里胡哨
    大概过程如下
        1. 为想要配置的域名申请一个证书，参考上面申请证书的步骤，注意的是此处服务器选择在哪证书就选择在哪
        2. 为对应的服务器实例配置一个目标组, 目标组端口为 80, 实例端口为 8080, 即为实例的 8080 端口添加一个外部映射端口 80
        3. 创建一个负载均衡器, 添加监听 443 端口, 并将其映射到指定目标组的 80 端口, 并选择证书
        4. 域名解析一个 CNAME 映射, 映射到负载均衡器的 DNS 上

### 创建目标组

    用于为多台机器的多个端口配置一个统一的端口,
    如: 现在有 A,B,C 三台实例, A 上部署了一个 Java 服务, 使用端口 80, B 上部署了两个 Java 服务, 使用端口 8080和8081, C 上部署了三个 Java 服务, 使用端口 80,8080,8081
    三台服务器上的五个 Java 服务都是一样的, 即集群部署, 具体如下: 
        A: 80
        B: 8080 8081
        C: 80 8080 8081
    此时实际上上面三台服务器的五个端口是提供一模一样的服务器, 我们需要为其提供负载均衡的配置, 但是单独配置比较费劲, 所以我们在外面添加一个目标组的配置, 目标组把这三台服务器的五个端口包裹起来, 
    然后只对外提供一个 80 端口, 这样访问这个目标组的 80 端口的意思就是指向这五个服务的端口, 即为这五个端口做一个汇总, 但这还不是真正的负载均衡,
    我们还需要添加一个负载均衡器, 将负载均衡器侦听的某个端口(实际上可以理解为一个域名)指向这个目标组的 80 端口, 这样负载均衡器每次侦听到设置端口被请求就会转发到目标组的端口中, 
    至于是轮训还是全部转发这估计会有能够进行配置的地方, 我只是用它来配置 HTTPS, 所以没有深究过
    
    因为同一个实例的不同应用都会有其自己的端口, 所以在单实例的情况下, 我们需要为不同应用的端口都配置一个目标组, 目标组端口都为 80 即可, 实例端口则为我们应用使用的端口

1. 选择左侧负载平衡下面的目标群组, 然后点击创建目标组
2. 选择目标类型为实例
3. 目标组名称输入一个
4. 协议选择 HTTP,  端口输入 80
5. VPC 选择默认的那个
6. 协议版本选择 HTTP1
7. 其它均默认即可, 点击下一步
8. 选择刚新创建的实例, 输入要将 80 端口指向该实例的哪个端口, 然后点击包含如下待处理事项, 然后点击创建目标组

### 负载均衡器

1. 选择左侧负载平衡下面的负载均衡器, 选择 Application Load Balancer, 此为默认的,  点击创建
2. 输入负载均衡器名称
3. 模式选择 面向互联网
4. IP 地址类型选择 IPv4
5. VPC 选择默认的那个即可
6. 映射, 三个全部选择即可
7. 安全组把默认的删了, 选择刚创建的那个
8. 侦听器和路由, 协议选择 HTTPS, 端口输入 443, 默认操作选择刚创建的目标组
9. 安全侦听器设置, 安全策略选择推荐的那个, 选择 从ACM中,  最后选择我们申请的证书
10. 点击创建负载均衡器
11. 测试, 等创建的负载均衡器的状态为 Active 时候, 复制其 DNS, 然后在浏览器将其打开, 如果我们服务器内部监听了目标组对应的端口, 此时应该是能够显示对应的页面的, 注意因为配置了证书, 所以 DNS 前面要加上 https://
12. 去到 Route 53 中为证书对应的域名添加一个 CNAME 映射, 目标指向负载均衡器的 DNS, 即可完成全部的 HTTPS 配置